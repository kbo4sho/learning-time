const stage=document.getElementById("game-of-the-day-stage");stage.innerHTML="";const canvas=document.createElement("canvas");canvas.width=720;canvas.height=480;stage.appendChild(canvas);const ctx=canvas.getContext("2d");const W=canvas.width,H=canvas.height;class Sound{constructor(src,volume=0.15){this.audio=new Audio(src);this.audio.volume=volume;}play(){const a=this.audio.cloneNode();a.volume=this.audio.volume;a.play();}}const correctSound=new Sound("https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg",0.25);const wrongSound=new Sound("https://actions.google.com/sounds/v1/cartoon/cartoon_whip.ogg",0.18);const bgMusic=new Sound("https://actions.google.com/sounds/v1/ambiences/forest.ogg",0.07);bgMusic.audio.loop=true;bgMusic.audio.play();function lerp(a,b,t){return a+(b-a)*t;}function dist(x1,y1,x2,y2){return Math.hypot(x2-x1,y2-y1);}function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}function randomColor(){const hues=["#8ecae6","#219ebc","#ffb703","#fb8500","#3a0ca3","#720026","#ff006e","#8338ec"];return hues[randomInt(0,hues.length-1)];}function drawRoundedRect(ctx,x,y,w,h,r,color){ctx.fillStyle=color;ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.fill();}function drawText(ctx,text,x,y,size,color,align="center"){ctx.fillStyle=color;ctx.font=`${size}px Comic Sans MS`;ctx.textAlign=align;ctx.fillText(text,x,y);}class Explorer{constructor(){this.x=W/2;this.y=H/2;this.size=48;this.color="#40916c";this.speed=3.5;this.target=null;this.wavingPhase=0;}draw(){ctx.save();ctx.translate(this.x,this.y);this.wavingPhase+=0.1;const wave=5*Math.sin(this.wavingPhase);ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(0,0,this.size/2,0,2*Math.PI);ctx.shadowColor="rgba(0,0,0,0.15)";ctx.shadowBlur=10;ctx.fill();ctx.shadowBlur=0;ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(-8,wave-6,8,0,2*Math.PI);ctx.fill();ctx.fillStyle="#000";ctx.beginPath();ctx.arc(-8,wave-6,4,0,2*Math.PI);ctx.fill();ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(8,wave-6,8,0,2*Math.PI);ctx.fill();ctx.fillStyle="#000";ctx.beginPath();ctx.arc(8,wave-6,4,0,2*Math.PI);ctx.fill();ctx.beginPath();ctx.moveTo(0,wave+12);ctx.lineTo(-14,wave+30);ctx.lineTo(14,wave+30);ctx.closePath();ctx.fillStyle="#276749";ctx.fill();ctx.restore();}move(){if(!this.target)return;const dx=this.target.x-this.x;const dy=this.target.y-this.y;const distnc=Math.hypot(dx,dy);if(distnc<1){this.x=this.target.x;this.y=this.target.y;this.target=null;return;}const vx=dx/distnc*this.speed;const vy=dy/distnc*this.speed;this.x+=vx;this.y+=vy;}}class Creature{constructor(x,y){this.x=x;this.y=y;this.size=48;this.baseColor=randomColor();this.highlight=false;this.text="";this.answer=null;this.question=null;this.bobbing=0;}draw(){this.bobbing+=0.03;ctx.save();ctx.translate(this.x,this.y+4*Math.sin(this.bobbing));ctx.shadowColor="rgba(0,0,0,0.12)";ctx.shadowBlur=8;ctx.fillStyle=this.highlight?"#fff4c1":this.baseColor;ctx.beginPath();ctx.ellipse(0,0,this.size*1.4,this.size*1.1,0,0,2*Math.PI);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle="#fffbea";ctx.beginPath();ctx.ellipse(0,0,this.size*1.05,this.size*0.7,0,0,2*Math.PI);ctx.fill();ctx.fillStyle="#333";drawText(ctx,this.text,0,14,26,"#222");ctx.strokeStyle="#5a381e";ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(-12,this.size*0.8);ctx.lineTo(-18,this.size+12);ctx.moveTo(12,this.size*0.8);ctx.lineTo(18,this.size+12);ctx.stroke();ctx.restore();}isClicked(px,py){return dist(px,py,this.x,this.y)<this.size*1.4;}setQuestion(){const a=randomInt(1,10);const b=randomInt(1,10);this.question=`${a} + ${b}`;this.answer=a+b;this.text=this.question;}clear(){this.text="";this.answer=null;this.question=null;this.highlight=false;}}class Game{constructor(){this.explorer=new Explorer();this.creatures=[];this.score=0;this.total=0;this.currentCreature=null;this.state="start";this.message="";this.timer=0;this.inputAnswer="";this.cursorBlink=true;this.lastBlink=0;this.inputX=360;this.inputY=440;this.createCreatures();window.addEventListener("click",e=>this.handleClick(e));window.addEventListener("keydown",e=>this.handleKey(e));this.animate= this.animate.bind(this);requestAnimationFrame(this.animate);this.backgroundStars=[];for(let i=0;i<50;i++){this.backgroundStars.push({x:Math.random()*W,y:Math.random()*200+20,r:Math.random()*1.5+0.3,phase:Math.random()*Math.PI*2});}this.bubbleParticles=[];}createCreatures(){for(let i=0;i<5;i++){let x=randomInt(80,W-80);let y=randomInt(100,H-130);const c=new Creature(x,y);c.setQuestion();this.creatures.push(c);}this.nextCreature();}nextCreature(){for(const c of this.creatures)c.highlight=false;const candidates=this.creatures.filter(c=>c.answer!==null);if(candidates.length===0){this.state="finished";this.message=`Adventure complete! You answered ${this.score} out of ${this.total} correctly.`;return;}const idx=randomInt(0,candidates.length-1);this.currentCreature=candidates[idx];this.currentCreature.highlight=true;this.explorer.target={x:this.currentCreature.x,y:this.currentCreature.y-80};this.inputAnswer="";this.total++;this.spawnBubbleParticles(this.currentCreature.x,this.currentCreature.y-50);}spawnBubbleParticles(x,y){for(let i=0;i<12;i++){this.bubbleParticles.push({x:x,y:y,vx:(Math.random()-0.5)*0.8,vy:-Math.random()*1.5-0.5,life:80,size:randomInt(3,6),opacity:1});}}handleClick(e){if(this.state!=="playing"&&this.state!=="start")return;if(this.state==="start"){this.state="playing";return;}const rect=canvas.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;if(this.currentCreature && this.currentCreature.isClicked(mx,my)){if(this.inputAnswer.length>0){const ans=parseInt(this.inputAnswer);if(ans===this.currentCreature.answer){correctSound.play();this.score++;this.currentCreature.clear();this.nextCreature();}else{wrongSound.play();this.message="Try again!";this.timer=60;}}}else{this.message="Click on the creature's bubble to answer.";} }handleKey(e){if(this.state!=="playing")return;if(e.key.match(/^[0-9]$/)){if(this.inputAnswer.length<3)this.inputAnswer+=e.key;this.message="";}else if(e.key==="Backspace"){this.inputAnswer=this.inputAnswer.slice(0,-1);}else if(e.key==="Enter"){if(this.inputAnswer.length>0){const ans=parseInt(this.inputAnswer);if(ans===this.currentCreature.answer){correctSound.play();this.score++;this.currentCreature.clear();this.nextCreature();}else{wrongSound.play();this.message="Try again!";this.timer=60;}}}}drawBackground(){ctx.fillStyle="#305f3d";let grd=ctx.createLinearGradient(0,0,0,H);grd.addColorStop(0,"#305f3d");grd.addColorStop(1,"#1b3a24");ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);ctx.fillStyle="rgba(255,255,255,0.3)";for(let star of this.backgroundStars){star.phase+=0.02;const brightness=0.6+0.4*Math.sin(star.phase);ctx.beginPath();ctx.ellipse(star.x,star.y,star.r*brightness,star.r*0.6*brightness,0,0,2*Math.PI);ctx.fill();}for(let y=300;y<H;y+=80){for(let x=0;x<W;x+=160){ctx.fillStyle=["#3b9a6a","#2b775a"][((x/160)+(y/80))%2];ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+80,y+48);ctx.lineTo(x,y+80);ctx.closePath();ctx.fill();}}}drawUI(){ctx.fillStyle="#d9f0e5";ctx.font="26px Comic Sans MS";ctx.textAlign="left";ctx.fillText(`Score: ${this.score} / ${this.total-1}`,18,42);ctx.shadowColor="rgba(0,0,0,0.3)";ctx.shadowBlur=7;drawText(ctx,"Explorer's Addition Quest",W/2,42,32,"#dff7e3");ctx.shadowBlur=0;}drawInputBox(){drawRoundedRect(ctx,this.inputX-90,this.inputY-36,180,56,16,"#e9f7ef");ctx.strokeStyle="#2a7a42";ctx.lineWidth=4;ctx.shadowColor="rgba(0,0,0,0.15)";ctx.shadowBlur=5;ctx.strokeRect(this.inputX-90,this.inputY-36,180,56);ctx.shadowBlur=0;ctx.fillStyle="#1b4332";ctx.font="32px Comic Sans MS";ctx.textAlign="center";ctx.fillText(this.inputAnswer||"?",this.inputX,this.inputY+16);if(this.cursorBlink){const tw=ctx.measureText(this.inputAnswer||"?").width;ctx.strokeStyle="#2a7a42";ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(this.inputX+tw/2+8,this.inputY-14);ctx.lineTo(this.inputX+tw/2+8,this.inputY+22);ctx.stroke();}}drawMessage(){if(!this.message)return;ctx.fillStyle="#da627d";ctx.font="22px Comic Sans MS";ctx.textAlign="center";ctx.shadowColor="rgba(0,0,0,0.1)";ctx.shadowBlur=8;ctx.fillText(this.message,W/2,H-28);ctx.shadowBlur=0;}animateParticles(){for(let i=this.bubbleParticles.length-1;i>=0;i--){let p=this.bubbleParticles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.02;p.life--;p.opacity=p.life/80;p.size=lerp(p.size,0,p.opacity*p.opacity);if(p.opacity<=0){this.bubbleParticles.splice(i,1);continue;}ctx.fillStyle=`rgba(255,255,255,${p.opacity})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,2*Math.PI);ctx.fill();}}animate(t=0){ctx.clearRect(0,0,W,H);this.drawBackground();this.animateParticles();for(const c of this.creatures)c.draw();this.explorer.move();this.explorer.draw();this.drawUI();if(this.state==="start"){ctx.fillStyle="#dff7e3";ctx.font="30px Comic Sans MS";ctx.textAlign="center";ctx.shadowColor="rgba(0,0,0,0.4)";ctx.shadowBlur=12;ctx.fillText("Welcome, young explorer!",W/2,H/2-72);ctx.fillText("Help the friendly creatures by solving addition puzzles.",W/2,H/2-24);ctx.fillText("Click anywhere to start your adventure.",W/2,H/2+32);ctx.shadowBlur=0;}if(this.state==="playing"){if(this.currentCreature){ctx.fillStyle="#e9f7df";ctx.font="26px Comic Sans MS";ctx.textAlign="center";ctx.shadowColor="rgba(0,0,0,0.2)";ctx.shadowBlur=6;ctx.fillText("Solve: "+this.currentCreature.question,this.inputX,H-72);ctx.shadowBlur=0;}this.drawInputBox();this.drawMessage();if(this.timer>0)this.timer--;else this.message="";this.cursorBlink=t-this.lastBlink>500?!this.cursorBlink:this.cursorBlink;if(t-this.lastBlink>500)this.lastBlink=t;}if(this.state==="finished"){ctx.fillStyle="#dff7e3";ctx.font="32px Comic Sans MS";ctx.textAlign="center";ctx.shadowColor="rgba(0,0,0,0.35)";ctx.shadowBlur=15;ctx.fillText(this.message,W/2,H/2);}requestAnimationFrame(this.animate);}}const game=new class extends Game{};