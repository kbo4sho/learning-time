const stage=document.getElementById("game-of-the-day-stage");stage.innerHTML="";const w=720,h=480;const canvas=document.createElement("canvas");canvas.width=w;canvas.height=h;stage.appendChild(canvas);const ctx=canvas.getContext("2d");const audioCtx=new(AudioContext||webkitAudioContext)();let bgMusicGain=null;let bgMusicOsc1=null;let bgMusicOsc2=null;function startBackgroundMusic(){if(bgMusicGain)return;bgMusicGain=audioCtx.createGain();bgMusicGain.gain.setValueAtTime(0.03,audioCtx.currentTime);bgMusicGain.connect(audioCtx.destination);bgMusicOsc1=audioCtx.createOscillator();bgMusicOsc2=audioCtx.createOscillator();bgMusicOsc1.type="sine";bgMusicOsc2.type="triangle";bgMusicOsc1.frequency.setValueAtTime(220,audioCtx.currentTime);bgMusicOsc2.frequency.setValueAtTime(440,audioCtx.currentTime);bgMusicOsc1.connect(bgMusicGain);bgMusicOsc2.connect(bgMusicGain);bgMusicOsc1.start();bgMusicOsc2.start();}function stopBackgroundMusic(){if(!bgMusicGain)return;bgMusicOsc1.stop();bgMusicOsc2.stop();bgMusicOsc1.disconnect();bgMusicOsc2.disconnect();bgMusicGain.disconnect();bgMusicGain=null;bgMusicOsc1=null;bgMusicOsc2=null;}function playTone(freq,dur){const osc=audioCtx.createOscillator();const gain=audioCtx.createGain();osc.connect(gain);gain.connect(audioCtx.destination);osc.type="triangle";osc.frequency.value=freq;gain.gain.setValueAtTime(0.12,audioCtx.currentTime);gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);osc.start();osc.stop(audioCtx.currentTime+dur);osc.onended=()=>gain.disconnect();}const bgColor="#b6d8f7";const grassColor="#6ebb57";const treeTrunk="#5a3f09";const treeLeaves="#2f7c21";const characterColor="#f48484";const characterShadowColor="rgba(0,0,0,0.2)";const pathColor="#e3dbaf";const stoneBaseColor="#d9d9d9";const stoneHighlightColor="#fff9db";const inventory=[];const stoneShadow="rgba(0,0,0,0.1)";const sounds={correct:587,wrong:195,click:440};class Explorer{constructor(){this.x=360;this.y=240;this.size=36;this.speed=3;this.armAngle=0;this.armDir=0.05;}draw(){ctx.save();ctx.shadowColor=characterShadowColor;ctx.shadowBlur=6;ctx.fillStyle=characterColor;ctx.beginPath();ctx.ellipse(this.x,this.y,this.size*0.7,this.size*0.95,0,0,2*Math.PI);ctx.fill();ctx.fillStyle="white";ctx.beginPath();ctx.ellipse(this.x-9,this.y-13,7,9,0,0,2*Math.PI);ctx.ellipse(this.x+9,this.y-13,7,9,0,0,2*Math.PI);ctx.fill();ctx.fillStyle="black";ctx.beginPath();ctx.ellipse(this.x-7,this.y-10,3,4,0,0,2*Math.PI);ctx.ellipse(this.x+11,this.y-10,3,4,0,0,2*Math.PI);ctx.fill();ctx.fillStyle="#653d3d";ctx.beginPath();ctx.moveTo(this.x,this.y+8);ctx.lineTo(this.x-14,this.y+30);ctx.lineTo(this.x+14,this.y+30);ctx.closePath();ctx.fill();ctx.translate(this.x,this.y+20);ctx.rotate(Math.sin(this.armAngle)*0.5);ctx.fillStyle="#d46a6a";ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(15,10);ctx.lineTo(10,20);ctx.lineTo(-5,10);ctx.closePath();ctx.fill();ctx.restore();}move(dir){switch(dir){case"left":if(this.x-this.speed>50)this.x-=this.speed;break;case"right":if(this.x+this.speed<w-50)this.x+=this.speed;break;case"up":if(this.y-this.speed>50)this.y-=this.speed;break;case"down":if(this.y+this.speed<h-50)this.y+=this.speed;break;}}animate(){this.armAngle+=this.armDir;if(this.armAngle>1||this.armAngle<-1)this.armDir*=-1;}}class Tree{constructor(x,y){this.x=x;this.y=y;this.width=32;this.height=75;}draw(){ctx.shadowColor="rgba(0,0,0,0.15)";ctx.shadowBlur=6;ctx.fillStyle=treeTrunk;ctx.beginPath();ctx.moveTo(this.x-7,this.y+35);ctx.lineTo(this.x+7,this.y+35);ctx.lineTo(this.x+5,this.y+65);ctx.lineTo(this.x-5,this.y+65);ctx.closePath();ctx.fill();ctx.shadowBlur=0;const leafColors=["#2b6e19","#3a8e30","#209010"];ctx.fillStyle=leafColors[0];ctx.beginPath();ctx.moveTo(this.x,this.y);ctx.lineTo(this.x-22,this.y+48);ctx.lineTo(this.x+22,this.y+48);ctx.closePath();ctx.fill();ctx.fillStyle=leafColors[1];ctx.beginPath();ctx.moveTo(this.x,this.y-20);ctx.lineTo(this.x-18,this.y+30);ctx.lineTo(this.x+18,this.y+30);ctx.closePath();ctx.fill();ctx.fillStyle=leafColors[2];ctx.beginPath();ctx.moveTo(this.x,this.y-40);ctx.lineTo(this.x-14,this.y+15);ctx.lineTo(this.x+14,this.y+15);ctx.closePath();ctx.fill();}}class Stone{constructor(x,y,answer){this.x=x;this.y=y;this.size=30;this.answer=answer;this.selected=false;this.hover=false;}draw(){ctx.save();ctx.shadowColor=stoneShadow;ctx.shadowBlur=8;ctx.fillStyle=this.selected?stoneHighlightColor:stoneBaseColor;const grad=ctx.createRadialGradient(this.x,this.y,this.size*0.2,this.x,this.y,this.size);grad.addColorStop(0,this.selected?"#fffbe0":"#ededed");grad.addColorStop(1,this.selected?"#c9c97e":"#a6a6a6");ctx.fillStyle=grad;ctx.beginPath();ctx.ellipse(this.x,this.y,this.size*1.3,this.size*0.9,Math.sin(Date.now()*0.002)*0.2,0,2*Math.PI);ctx.fill();ctx.fillStyle="#3d3d3d";ctx.font="22px Comic Sans MS";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(this.answer,this.x,this.y);if(this.hover&&!this.selected){ctx.strokeStyle="#fff";ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(this.x,this.y,this.size*1.4,this.size,0,0,2*Math.PI);ctx.stroke();}ctx.restore();}wasClicked(mx,my){const dx=mx-this.x;const dy=my-this.y;return dx*dx/(this.size*1.3*this.size*1.3)+dy*dy/(this.size*0.9*this.size*0.9)<=1;}}class Parrot{constructor(){this.x=110;this.y=110;this.state=0;this.colorFrames=[ "#ff6f6f90","#ff4a4a90","#ff7a4a90","#ffa47a90" ];this.wingAngle=0;this.wingDir=0.07;this.bob=0;this.bobDir=0.04;this.soundPlaying=false;}draw(){ctx.save();ctx.shadowColor="rgba(0,0,0,0.2)";ctx.shadowBlur=4;const c=this.colorFrames[this.state%this.colorFrames.length];ctx.fillStyle=c;ctx.beginPath();ctx.ellipse(this.x,this.y+Math.sin(this.bob)*6,28,22,0,0,2*Math.PI);ctx.fill();ctx.fillStyle="#065006";ctx.beginPath();ctx.moveTo(this.x,this.y-20+Math.sin(this.bob)*6);ctx.lineTo(this.x-12,this.y+15+Math.sin(this.bob)*6);ctx.lineTo(this.x+12,this.y+15+Math.sin(this.bob)*6);ctx.closePath();ctx.fill();ctx.fillStyle="#222222";ctx.beginPath();ctx.ellipse(this.x+12,this.y-5+Math.sin(this.bob)*6,7,9,0,0,2*Math.PI);ctx.fill();ctx.fillStyle="white";ctx.beginPath();ctx.ellipse(this.x+8,this.y-5+Math.sin(this.bob)*6,3,3,0,0,2*Math.PI);ctx.fill();ctx.translate(this.x,this.y+Math.sin(this.bob)*6);ctx.rotate(Math.sin(this.wingAngle)*0.6);ctx.fillStyle="#ff7f7f";ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(30,-14);ctx.lineTo(25,5);ctx.closePath();ctx.fill();ctx.restore();}animate(){this.state++;this.wingAngle+=this.wingDir;if(this.wingAngle>1||this.wingAngle<-1)this.wingDir*=-1;this.bob+=this.bobDir;if(this.bob>2||this.bob<-2)this.bobDir*=-1;if(this.state%40===0&&Math.random()<0.35){this.x=50+Math.random()*(w-100);this.y=50+Math.random()*(h-120);playTone(440,0.15);}}}const explorer=new Explorer();const trees=[new Tree(120,320),new Tree(480,350),new Tree(600,280),new Tree(300,380),new Tree(550,180),new Tree(180,220)];const stones=[];let currentSum=0;let targetSum=0;let parrot=new Parrot();let mouseX=0;let mouseY=0;function pickTarget(){return 5+Math.floor(Math.random()*15);}function placeStones(){stones.length=0;const answers=[];answers.push(targetSum);while(answers.length<6){let val=3+Math.floor(Math.random()*17);if(!answers.includes(val))answers.push(val);}answers.sort(()=>Math.random()-0.5);for(let i=0;i<answers.length;i++){let baseX=100+ i*100 + (i%2)*20;let baseY=400 + ((i%2)*27-13);stones.push(new Stone(baseX,baseY,answers[i]));}}function drawBackground(){ctx.fillStyle=bgColor;ctx.fillRect(0,0,w,h);const grad=ctx.createLinearGradient(0,0,0,h);grad.addColorStop(0,"#bde0fa");grad.addColorStop(1,grassColor);ctx.fillStyle=grad;ctx.fillRect(0,h-100,w,100);ctx.fillStyle=pathColor;ctx.shadowColor="rgba(0,0,0,0.15)";ctx.shadowBlur=12;ctx.beginPath();ctx.moveTo(0,h-100);ctx.lineTo(720,h-100);ctx.lineTo(720,h-155);ctx.lineTo(0,h-155);ctx.closePath();ctx.fill();ctx.shadowBlur=0;trees.forEach(t=>t.draw());}let questionStage=0;function newQuestion(){targetSum=pickTarget();currentSum=0;placeStones();stones.forEach(s=>{s.selected=false;s.hover=false});questionStage=0;}function drawText(){ctx.fillStyle="#004d00";ctx.font="28px Comic Sans MS";ctx.textAlign="left";ctx.fillText("Help Explorer find total sum of: ",20,40);ctx.fillStyle="#278027";ctx.font="38px Comic Sans MS";ctx.fillText(targetSum,400,40);ctx.fillStyle="#004400";ctx.font="22px Comic Sans MS";ctx.fillText("Tap stones to add or remove from backpack",20,75);ctx.fillStyle="#654321";ctx.font="28px Comic Sans MS";ctx.fillText("Backpack sum: "+currentSum,20,440);}function drawBackpack(){ctx.shadowColor="rgba(0,0,0,0.25)";ctx.shadowBlur=8;ctx.fillStyle="#78391a";ctx.fillRect(580,410,130,65);ctx.shadowBlur=0;ctx.fillStyle="#fff5e1";ctx.font="24px Comic Sans MS";ctx.fillText("Backpack",590,445);}function checkAnswer(){if(currentSum===targetSum){playTone(880,0.45);parrot.soundPlaying=true;questionStage=2;}else if(currentSum>targetSum){playTone(195,0.5);questionStage=1;}}canvas.addEventListener("mousemove",e=>{const rect=canvas.getBoundingClientRect();mouseX=e.clientX-rect.left;mouseY=e.clientY-rect.top;let hovering=false;if(questionStage!==2){stones.forEach(s=>{if(s.wasClicked(mouseX,mouseY)){s.hover=true;hovering=true;}else s.hover=false;});if(!hovering)stones.forEach(s=>s.hover=false);}else stones.forEach(s=>s.hover=false);});canvas.onclick=function(e){if(audioCtx.state!=="running")audioCtx.resume().then(startBackgroundMusic);const rect=canvas.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;if(questionStage!==2){for(let s of stones)if(s.wasClicked(mx,my)){if(!s.selected){s.selected=true;currentSum+=s.answer;playTone(s.answer*18,0.15);checkAnswer();}else{currentSum-=s.answer;s.selected=false;playTone(150,0.14);}break;}}else{newQuestion();}}}function drawExplorer(){ctx.save();ctx.shadowColor="rgba(0,0,0,0.15)";ctx.shadowBlur=8;explorer.draw();ctx.restore();}function drawStones(){stones.forEach(s=>s.draw());}function animate(){ctx.clearRect(0,0,w,h);drawBackground();drawStones();drawExplorer();parrot.draw();drawText();drawBackpack();parrot.animate();explorer.animate();requestAnimationFrame(animate);}newQuestion();animate();