const stage=document.getElementById("game-of-the-day-stage");stage.innerHTML="";const canvas=document.createElement("canvas");canvas.width=720;canvas.height=480;stage.appendChild(canvas);const ctx=canvas.getContext("2d");const sounds={correct:new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"),incorrect:new Audio("https://actions.google.com/sounds/v1/cartoon/boing.ogg"),bg:new Audio("https://actions.google.com/sounds/v1/ambiences/magical_forest.ogg")};sounds.bg.loop=true;sounds.bg.volume=0.15;sounds.bg.play();const sparkleCanvas=document.createElement("canvas");sparkleCanvas.width=720;sparkleCanvas.height=480;const sparkleCtx=sparkleCanvas.getContext("2d");let sparkleParticles=[];function createSparkle(){return{ x:Math.random()*720, y:Math.random()*400+50, radius:0.6+Math.random()*0.8, alpha:0.2+Math.random()*0.5, phase:Math.random()*Math.PI*2, speed:0.01+Math.random()*0.02, color:`hsl(60, 80%, 88%)` };}for(let i=0;i<70;i++)sparkleParticles.push(createSparkle());const explorer={x:360,y:440,r:25,color:"#6CA0DC",eyesXOffset:8,eyesYOffset:5};const map={width:700,height:400,x:10,y:50,color:"#789262"};const gems=["#E63946","#1D3557","#F1FA3C","#7B2FF7"];const collected=[];const animals=[{x:120,y:150,color:"#F2994A",name:"Blinky the Bird"},{x:580,y:180,color:"#7B3920",name:"Momo the Monkey"},{x:310,y:320,color:"#3AAE9F",name:"Gus the Gecko"}];const mathQuestions=[{question:"You find 3 shiny stones and then 4 more. How many stones do you have?",answer:7},{question:"You spot 5 colorful flowers and pick 2. How many flowers are left?",answer:3},{question:"You hear 6 frogs croaking and 3 birds singing. How many animals are making sounds?",answer:9}];let currentQuestionIndex=0;let answerInput="";let message="Explore the forest and solve the math puzzles to help your friends! Use arrow keys to move.";let showPopup=false;let popupText="";let popupTimer=0;let glowTimer=0;function drawBackground(){const grad=ctx.createLinearGradient(0,0,0,480);grad.addColorStop(0,"#c0dfd4");grad.addColorStop(1,"#7bac7a");ctx.fillStyle=grad;ctx.fillRect(0,0,720,480);ctx.fillStyle=map.color;ctx.beginPath();ctx.moveTo(map.x,map.y);ctx.lineTo(map.x+map.width,map.y+40);ctx.lineTo(map.x+map.width,map.y+map.height);ctx.lineTo(map.x,map.y+map.height-25);ctx.closePath();ctx.shadowColor="rgba(0,0,0,0.15)";ctx.shadowBlur=15;ctx.fill();ctx.shadowBlur=0;for(let i=0;i<10;i++){ctx.fillStyle=`rgba(30,80,20,${0.1+i*0.07})`;ctx.beginPath();ctx.ellipse(map.x+70*i,map.y+map.height-25,32,18,0,0,Math.PI*2);ctx.fill();}sparkleCtx.clearRect(0,0,720,480);sparkleParticles.forEach(p=>{p.phase+=p.speed;p.alpha=0.3+Math.sin(p.phase)*0.3;sparkleCtx.fillStyle=`rgba(255,255,210,${p.alpha.toFixed(2)})`;sparkleCtx.beginPath();sparkleCtx.ellipse(p.x,p.y,p.radius*1.4,p.radius*0.7,0,0,Math.PI*2);sparkleCtx.fill();});ctx.drawImage(sparkleCanvas,0,0);}function drawExplorer(){const glowRadius=explorer.r+6+3*Math.sin(glowTimer*0.1);glowTimer++;ctx.shadowColor="rgba(108,160,220,0.6)";ctx.shadowBlur=14;ctx.fillStyle=explorer.color;ctx.beginPath();ctx.arc(explorer.x,explorer.y,explorer.r,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle="#A6CEF7";ctx.beginPath();ctx.arc(explorer.x-explorer.eyesXOffset,explorer.y-explorer.eyesYOffset,9,0,Math.PI*2);ctx.arc(explorer.x+explorer.eyesXOffset,explorer.y-explorer.eyesYOffset,9,0,Math.PI*2);ctx.fill();ctx.fillStyle="#073763";ctx.beginPath();ctx.arc(explorer.x-explorer.eyesXOffset,explorer.y-explorer.eyesYOffset,4,0,Math.PI*2);ctx.arc(explorer.x+explorer.eyesXOffset,explorer.y-explorer.eyesYOffset,4,0,Math.PI*2);ctx.fill();ctx.strokeStyle="#224466";ctx.lineWidth=3;ctx.beginPath();ctx.arc(explorer.x,explorer.y+12,12,Math.PI*0.15,Math.PI*0.85);ctx.stroke();}function drawAnimals(){const time=Date.now();animals.forEach(a=>{const swing=3*Math.sin(time/600+a.x/10);ctx.shadowColor="rgba(0,0,0,0.1)";ctx.shadowBlur=5;ctx.fillStyle=a.color;ctx.beginPath();ctx.ellipse(a.x+swing,a.y,20,30,Math.sin(time/600)*0.1,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle="#fff";ctx.beginPath();ctx.ellipse(a.x-7+swing,a.y-7,7,10,0,0,Math.PI*2);ctx.ellipse(a.x+7+swing,a.y-7,7,10,0,0,Math.PI*2);ctx.fill();ctx.fillStyle="#000";ctx.beginPath();ctx.ellipse(a.x-7+swing,a.y-7,3,5,0,0,Math.PI*2);ctx.ellipse(a.x+7+swing,a.y-7,3,5,0,0,Math.PI*2);ctx.fill();ctx.fillStyle="#7B4F2A";ctx.beginPath();ctx.moveTo(a.x+swing,a.y+12);ctx.lineTo(a.x-10+swing,a.y+28);ctx.lineTo(a.x+10+swing,a.y+28);ctx.closePath();ctx.fill();});}function drawGems(){collected.forEach((gem,i)=>{const x=30+i*50;const y=40;ctx.shadowColor=`rgba(255,255,255,0.8)`;ctx.shadowBlur=12;ctx.fillStyle=gem;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+12,y-25);ctx.lineTo(x+25,y);ctx.lineTo(x+12,y+25);ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.strokeStyle="#fff";ctx.lineWidth=2;ctx.stroke();});}function drawMathQuestion(){ctx.fillStyle="#272626";ctx.font="22px Comic Sans MS";ctx.textAlign="center";ctx.shadowColor="rgba(0,0,0,0.2)";ctx.shadowBlur=2;ctx.fillText(mathQuestions[currentQuestionIndex].question,360,420);ctx.shadowBlur=0;ctx.font="48px Comic Sans MS";ctx.fillStyle="#2A6F97";ctx.fillText(answerInput||"?",360,470);ctx.strokeStyle="#1B455E";ctx.lineWidth=3;ctx.strokeRect(300,435,120,50);}function showMessage(text,color="#1B3B2D"){ctx.fillStyle=color;ctx.font="20px Comic Sans MS";ctx.textAlign="center";ctx.fillText(text,360,28);}function checkAnswer(){const correctAnswer=mathQuestions[currentQuestionIndex].answer;if(parseInt(answerInput)===correctAnswer){sounds.correct.currentTime=0;sounds.correct.play();collected.push(gems[currentQuestionIndex]);popupText="Great job! "+animals[currentQuestionIndex].name+" thanks you!";showPopup=true;popupTimer=180;currentQuestionIndex++;answerInput="";if(currentQuestionIndex>=mathQuestions.length){popupText="You helped all your friends! Adventure complete!";}else{message="Use arrow keys to move and reach the next friend.";}return true;}else{if(answerInput.length>0){sounds.incorrect.currentTime=0;sounds.incorrect.play();popupText="Thatâ€™s not quite right, try again!";showPopup=true;popupTimer=120;}return false;}}function collisionCircle(aX,aY,aR,bX,bY,bR){const dx=aX-bX;const dy=aY-bY;const dist=dx*dx+dy*dy;return dist<=(aR+bR)*(aR+bR);}window.addEventListener("keydown",e=>{const speed=5;if(showPopup&&popupTimer>0&&(e.key==="Enter"||e.key==="Escape")){showPopup=false;popupTimer=0;return;}if(e.key==="ArrowLeft"){explorer.x=Math.max(map.x+explorer.r,explorer.x-speed);}else if(e.key==="ArrowRight"){explorer.x=Math.min(map.x+map.width-explorer.r,explorer.x+speed);}else if(e.key==="ArrowUp"){explorer.y=Math.max(map.y+explorer.r,explorer.y-speed);}else if(e.key==="ArrowDown"){explorer.y=Math.min(map.y+map.height-explorer.r,explorer.y+speed);}else if(e.key>="0"&&e.key<="9"){if(!showPopup){answerInput+=e.key;if(answerInput.length>2)answerInput=answerInput.slice(0,2);}}else if(e.key==="Backspace"){if(!showPopup)answerInput=answerInput.slice(0,-1);}else if(e.key==="Enter"){if(!showPopup)checkAnswer();}e.preventDefault();});function drawPopup(){ctx.fillStyle="rgba(255,255,255,0.96)";ctx.shadowColor="rgba(0,0,0,0.25)";ctx.shadowBlur=14;ctx.fillRect(140,185,440,110);ctx.shadowBlur=0;ctx.strokeStyle="#246B54";ctx.lineWidth=4;ctx.strokeRect(140,185,440,110);ctx.fillStyle="#246B54";ctx.font="26px Comic Sans MS";ctx.textAlign="center";ctx.fillText(popupText,360,250);}function gameLoop(){ctx.clearRect(0,0,720,480);drawBackground();drawAnimals();drawExplorer();drawGems();drawMathQuestion();showMessage(message);if(showPopup){drawPopup();popupTimer--;}else{popupTimer=0;}if(currentQuestionIndex>=mathQuestions.length){message="You found all treasures! Press F5 to play again.";}else{let nearFriend=false;for(let i=currentQuestionIndex;i<animals.length;i++){const a=animals[i];if(collisionCircle(explorer.x,explorer.y,explorer.r,a.x,a.y,32)){message="Solve the puzzle for "+a.name+": Press Number keys and Enter!";nearFriend=true;break;}}if(!nearFriend&&!showPopup){message="Explore... Use arrow keys to reach your friend and solve puzzles!";}}}setInterval(gameLoop,1000/30);