const stage=document.getElementById("game-of-the-day-stage");stage.innerHTML="";const canvas=document.createElement("canvas");canvas.width=720;canvas.height=480;stage.appendChild(canvas);const ctx=canvas.getContext("2d");const audioCtx=new(window.AudioContext||window.webkitAudioContext)();let keys={};document.addEventListener("keydown",e=>{keys[e.key.toLowerCase()]=true});document.addEventListener("keyup",e=>{keys[e.key.toLowerCase()]=false});const playSound=(freq,dur,volume=0.2,type="sine")=>{const osc=audioCtx.createOscillator();const gain=audioCtx.createGain();osc.frequency.value=freq;osc.type=type;gain.gain.value=volume*0.8;osc.connect(gain);gain.connect(audioCtx.destination);osc.start();osc.stop(audioCtx.currentTime+dur);osc.onended=()=>{gain.disconnect();osc.disconnect()}};const playCorrect=()=>playSound(880,0.18,0.25,"triangle");const playWrong=()=>playSound(220,0.35,0.15,"sawtooth");const playStep=()=>playSound(440,0.07,0.08,"square");const bkgAudioCtx=new(window.AudioContext||window.webkitAudioContext)();let bgGain=bkgAudioCtx.createGain();bgGain.gain.value=0.04;bgGain.connect(bkgAudioCtx.destination);const createBackgroundSound=()=>{const osc1=bkgAudioCtx.createOscillator();const osc2=bkgAudioCtx.createOscillator();const gain1=bkgAudioCtx.createGain();const gain2=bkgAudioCtx.createGain();osc1.frequency.value=55;osc1.type="sine";osc2.frequency.value=110;osc2.type="triangle";gain1.gain.value=0.06;gain2.gain.value=0.04;osc1.connect(gain1);gain1.connect(bgGain);osc2.connect(gain2);gain2.connect(bgGain);osc1.start();osc2.start();return ()=>{osc1.stop();osc2.stop();gain1.disconnect();gain2.disconnect()}};const stopBackgroundSound=createBackgroundSound();class Explorer{constructor(){this.x=360;this.y=240;this.size=48;this.color="#ff8c42";this.speed=3;this.wobbly=0;this.wobblyDir=1;this.tailPoints=[]}draw(){this.wobbly+=this.wobblyDir*0.12;if(this.wobbly>1.5||this.wobbly<-1.5)this.wobblyDir*=-1;this.tailPoints.unshift({x:this.x-this.wobbly*12,y:this.y+this.wobbly*8});if(this.tailPoints.length>20)this.tailPoints.pop();ctx.save();ctx.shadowColor="rgba(255,140,66,0.6)";ctx.shadowBlur=12;ctx.fillStyle=this.color;ctx.beginPath();ctx.ellipse(this.x,this.y,this.size*0.5,this.size*0.7,this.wobbly*0.15,0,Math.PI*2);ctx.fill();ctx.fillStyle="#fff";ctx.beginPath();ctx.ellipse(this.x+this.wobbly*10,this.y-this.size*0.15,8,11,0,0,Math.PI*2);ctx.fill();ctx.fillStyle="#000";ctx.beginPath();ctx.ellipse(this.x+this.wobbly*10,this.y-this.size*0.15,3,5,0,0,Math.PI*2);ctx.fill();ctx.restore();ctx.strokeStyle="rgba(255,140,66,0.4)";ctx.lineWidth=10;ctx.lineCap="round";for(let i=0;i<this.tailPoints.length-1;i++){const p1=this.tailPoints[i];const p2=this.tailPoints[i+1];ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.stroke()}}}class FriendlyAlien{constructor(x,y){this.x=x;this.y=y;this.size=60;this.eyeSize=14;this.bubbleActive=false;this.bubbleText="";this.bubbleTimer=0;this.colorMain="#7ccb7c";this.colorAccent="#4a8f4a"}draw(){ctx.save();ctx.shadowColor="rgba(74,143,74,0.6)";ctx.shadowBlur=14;ctx.fillStyle=this.colorMain;ctx.beginPath();ctx.ellipse(this.x,this.y,this.size*0.65,this.size*1.05,Math.sin(Date.now()/1000)*0.15,0,Math.PI*2);ctx.fill();ctx.fillStyle=this.colorAccent;ctx.beginPath();ctx.ellipse(this.x,this.y,this.size*0.55,this.size*0.85,Math.sin(Date.now()/1200)*0.25,0,Math.PI*2);ctx.fill();ctx.fillStyle="#fff";ctx.beginPath();ctx.ellipse(this.x-14,this.y-14,this.eyeSize,this.eyeSize*1.3,0,0,Math.PI*2);ctx.ellipse(this.x+14,this.y-14,this.eyeSize,this.eyeSize*1.3,0,0,Math.PI*2);ctx.fill();ctx.fillStyle="#000";ctx.beginPath();ctx.ellipse(this.x-14,this.y-14,this.eyeSize/2,this.eyeSize*0.8,0,0,Math.PI*2);ctx.ellipse(this.x+14,this.y-14,this.eyeSize/2,this.eyeSize*0.8,0,0,Math.PI*2);ctx.fill();ctx.strokeStyle="#317a31";ctx.lineWidth=3;ctx.beginPath();ctx.arc(this.x,this.y+18,18,0,Math.PI);ctx.stroke();ctx.restore();if(this.bubbleActive){ctx.fillStyle="rgba(255,255,255,0.9)";ctx.strokeStyle="#3a893a";ctx.lineWidth=4;ctx.font="22px Comic Sans MS";ctx.textAlign="center";ctx.textBaseline="middle";const w=Math.min(320,ctx.measureText(this.bubbleText).width);const h=36;ctx.beginPath();ctx.moveTo(this.x+8,this.y-this.size-14);ctx.lineTo(this.x+20,this.y-this.size-44);ctx.lineTo(this.x+32,this.y-this.size-14);ctx.closePath();ctx.fill();ctx.stroke();ctx.fillRect(this.x-w/2-10,this.y-this.size-50,w+20,h);ctx.strokeRect(this.x-w/2-10,this.y-this.size-50,w+20,h);ctx.fillStyle="#317a31";ctx.fillText(this.bubbleText,this.x,this.y-this.size-32)}}updateBubble(text){this.bubbleText=text;this.bubbleActive=true;this.bubbleTimer=280}tick(){if(this.bubbleTimer>0)this.bubbleTimer--;else this.bubbleActive=false}}class MathCrystal{constructor(x,y,value){this.x=x;this.y=y;this.size=36;this.value=value;this.collected=false;this.glow=0;this.glowDir=0.04}draw(){if(this.collected)return;this.glow+=this.glowDir;if(this.glow>0.8||this.glow<0)this.glowDir*=-1;ctx.save();ctx.shadowColor=`rgba(255,255,255,${this.glow})`;ctx.shadowBlur=20;ctx.fillStyle=`hsl(${(this.value*42+90)%360},75%,70%)`;ctx.beginPath();ctx.moveTo(this.x,this.y-this.size);ctx.lineTo(this.x+this.size,this.y);ctx.lineTo(this.x,this.y+this.size);ctx.lineTo(this.x-this.size,this.y);ctx.closePath();ctx.fill();ctx.strokeStyle="#666";ctx.lineWidth=4;ctx.stroke();ctx.shadowColor="transparent";ctx.fillStyle="#222";ctx.font="22px Comic Sans MS";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(this.value,this.x,this.y);ctx.restore()}}class World{constructor(){this.explorer=new Explorer();this.aliens=[new FriendlyAlien(170,140),new FriendlyAlien(570,350),new FriendlyAlien(370,90)];this.crystals=[];this.crystals.push(new MathCrystal(110,410,2));this.crystals.push(new MathCrystal(610,435,3));this.crystals.push(new MathCrystal(360,315,1));this.crystals.push(new MathCrystal(230,240,4));this.crystals.push(new MathCrystal(540,155,5));this.score=0;this.goal=0;this.question="";this.feedback="";this.feedbackTimer=0;this.generateQuestion();this.bgPattern=createForestBkgPattern()}generateQuestion(){const c1=this.randomCrystalValue();const c2=this.randomCrystalValue();this.currentSum=c1+c2;this.question=`Help explorer find crystals summing to ${this.currentSum}!`;this.goal=this.currentSum;this.score=0;this.crystals.forEach(c=>c.collected=false)}randomCrystalValue(){const values=this.crystals.map(c=>c.value);return values[Math.floor(Math.random()*values.length)]}checkCollection(){for(const c of this.crystals){if(c.collected)continue;const dx=this.explorer.x-c.x;const dy=this.explorer.y-c.y;const dist=Math.sqrt(dx*dx+dy*dy);if(dist<45)return c}return null}collectCrystal(c){c.collected=true;this.score+=c.value;playCorrect();this.aliens.forEach(a=>a.updateBubble(`Found ${c.value}!`));if(this.score===this.goal){this.feedback="Great! Sum matched! ðŸŽ‰";playSound(950,0.3,0.4,"triangle")}else if(this.score>this.goal){this.feedback="Too many points! Try again.";playWrong();this.score=0;this.crystals.forEach(cr=>cr.collected=false)}else this.feedback="Keep going!";playStep();this.feedbackTimer=180}update(){if(keys["arrowleft"]||keys["a"])this.explorer.x-=this.explorer.speed;if(keys["arrowright"]||keys["d"])this.explorer.x+=this.explorer.speed;if(keys["arrowup"]||keys["w"])this.explorer.y-=this.explorer.speed;if(keys["arrowdown"]||keys["s"])this.explorer.y+=this.explorer.speed;this.explorer.x=Math.max(28,Math.min(canvas.width-28,this.explorer.x));this.explorer.y=Math.max(28,Math.min(canvas.height-28,this.explorer.y));const collected=this.checkCollection();if(collected)this.collectCrystal(collected);this.aliens.forEach(a=>a.tick());if(this.feedbackTimer>0)this.feedbackTimer--}drawTextBubble(text,x,y,width=300,height=70){ctx.fillStyle="rgba(255,255,255,0.92)";ctx.strokeStyle="#448844";ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(x,y);ctx.bezierCurveTo(x+width/2,y-height/1.3,x+width/2,y-height/1.3,x+width,y);ctx.lineTo(x+width,y+height);ctx.bezierCurveTo(x+width/2,y+height/0.8,x+width/2,y+height/0.8,x,y+height);ctx.closePath();ctx.fill();ctx.stroke();ctx.fillStyle="#2e7d32";ctx.font="26px Comic Sans MS";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(text,x+width/2,y+height/2)}draw(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#b3ede2";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle=this.bgPattern;ctx.globalAlpha=0.4;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.globalAlpha=1;for(let i=0;i<15;i++){ctx.fillStyle=`rgba(255,255,255,${(0.05+0.04*Math.sin(Date.now()/1000+i))})`;ctx.beginPath();const cx=(i*47+Date.now()/30)%canvas.width;const cy=40+20*Math.sin(Date.now()/1800+i);ctx.ellipse(cx,cy,40,24,Math.sin(Date.now()/600+i)*0.4,0,Math.PI*2);ctx.fill()}this.crystals.forEach(c=>c.draw());this.explorer.draw();this.aliens.forEach(a=>a.draw());ctx.fillStyle="#2e7d32";ctx.font="29px Comic Sans MS";ctx.textAlign="left";ctx.fillText(this.question,12,36);if(this.feedbackTimer>0)this.drawTextBubble(this.feedback,170,380,380,70);ctx.fillStyle="#397d39";ctx.font="27px Comic Sans MS";ctx.textAlign="right";ctx.fillText(`Collected: ${this.score}`,canvas.width-24,36)}}function createForestBkgPattern(){const patternCanvas=document.createElement("canvas");patternCanvas.width=50;patternCanvas.height=50;const pctx=patternCanvas.getContext("2d");const bgColors=["#d0f0de","#b7ddbb","#a4d3a4","#8fcf8f"];pctx.fillStyle=bgColors[0];pctx.fillRect(0,0,50,50);pctx.fillStyle=bgColors[1];pctx.beginPath();pctx.moveTo(10,40);pctx.lineTo(20,5);pctx.lineTo(30,40);pctx.closePath();pctx.fill();pctx.fillStyle=bgColors[2];pctx.beginPath();pctx.moveTo(20,40);pctx.lineTo(30,8);pctx.lineTo(40,40);pctx.closePath();pctx.fill();pctx.fillStyle=bgColors[3];pctx.beginPath();pctx.moveTo(30,40);pctx.lineTo(40,12);pctx.lineTo(50,40);pctx.closePath();pctx.fill();pctx.fillStyle="#257425";pctx.beginPath();pctx.arc(25,45,10,0,Math.PI);pctx.fill();return ctx.createPattern(patternCanvas,"repeat")}const world=new World();function loop(){world.update();world.draw();requestAnimationFrame(loop)}loop();